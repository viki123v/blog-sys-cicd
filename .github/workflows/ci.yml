name: CI 

on:
    # pull_request:
        # branches: [ master ]
        # types: [ opened, reopened, synchronize ]
    push:
        branches: 
          - "**"

permissions:
  pull-requests: read
  actions: write 
  packages: write

jobs:
    fronted-check: 
      name: Frontend changed 
      uses: ./.github/workflows/checks.yml
      with: 
          fs-path: frontend/**
    frontend:
        name: Frontend 
        runs-on: ubuntu-latest
        needs: [ fronted-check ] 
        if: ${{needs.fronted-check.outputs.run == 'true'}}
        defaults:
          run:
            working-directory: ./frontend
        steps:
            - name: Get code 
              uses: actions/checkout@v5

            - name: Setup Node.js 
              uses: actions/setup-node@v4
              with:
                node-version-file: 'frontend/.nvmrc'

            - name: Install deps 
              run: npm i 
            
            - name: Linting | Formatting | Typecheck 
              run: npm run lint && npm run format:check
            
            - name: Log in to GitHub Container Registry
              if: github.event_name == 'push'
              uses: docker/login-action@v2
              with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}

            - name: Get tag for image 
              if: github.event_name == 'push'
              id: get_tag
              run: |
                  git fetch --tags
                  TAG=$(git tag --points-at HEAD | head -n 1)
                  echo "Tag for this commit: $TAG"
                  echo "TAG=$TAG" >> $GITHUB_OUTPUT

            - name: Build Docker image
              if: github.event_name == 'push' && steps.get_tag.outputs.TAG != ''
              run: |
                 cd .. 
                 docker build -t ghcr.io/viki123v/blog-sys-cicd/fe:${{ steps.get_tag.outputs.TAG }} -f infra/frontend.Dockerfile . 

            - name: Push Docker image
              if: github.event_name == 'push' && steps.get_tag.outputs.TAG != ''
              run: |
                docker push ghcr.io/viki123v/blog-sys-cicd/fe:${{ steps.get_tag.outputs.TAG }}

                docker tag ghcr.io/viki123v/blog-sys-cicd/fe:${{ steps.get_tag.outputs.TAG }} ghcr.io/viki123v/blog-sys-cicd/fe:latest 
                docker push ghcr.io/viki123v/blog-sys-cicd/fe:latest

    backend-check: 
      name: Backend changed 
      uses: ./.github/workflows/checks.yml
      with: 
          fs-path: backend/** 

    backend:
        name: Backend 
        runs-on: ubuntu-latest
        needs: [ backend-check ] 
        if: ${{needs.backend-check.outputs.run == 'true'}}
        defaults:
          run:
            working-directory: ./backend
        steps:
            - name: Get code 
              uses: actions/checkout@v5
            
            - name: Install python 
              uses: actions/setup-python@v5
              with: 
                python-version-file: 'backend/.python-version'

            - name: Install uv
              uses: astral-sh/setup-uv@v6
            
            - name: Install deps 
              run: uv sync --locked --all-extras --dev
            
            - name: Lint | Format | Typecheck 
              run: |
                uv run ruff format --check .
                uv run ruff check . 
                uv run mypy .
            
            - name: Log in to GitHub Container Registry
              if: github.event_name == 'push'
              uses: docker/login-action@v2
              with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build Docker image
              if: github.event_name == 'push'
              run: |
                cd .. 
                docker build -t ghcr.io/viki123v/blog-sys-cicd/be:latest -f infra/backnend.Dockerfile . 

            - name: Push Docker image
              if: github.event_name == 'push'
              run: |
                docker push ghcr.io/viki123v/blog-sys-cicd/be:latest
